<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Ø¢Ø³Ø§Ù† Ù…ÛŒØ±Ø§Ø« - Ù…Ú©Ù…Ù„ Ø§Ø³Ù„Ø§Ù…ÛŒ ÙˆØ±Ø§Ø«Øª (Ø¢Ø³Ø§Ù† Ø¹Ù„Ù… Ù…ÛŒØ±Ø§Ø« + Ø§Ù„Ø³Ø±Ø§Ø¬ÛŒ)</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Nastaliq Urdu', 'Jameel Noori Nastaleeq', 'Arial', sans-serif;
        }
        body {
            background: linear-gradient(145deg, #0b3b2c, #1a5a44);
            min-height: 100vh;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .app-container {
            max-width: 750px;
            width: 100%;
            background: white;
            border-radius: 40px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.35);
            overflow: hidden;
            border: 2px solid #c9a959;
        }
        .header {
            background: #0b3b2c;
            color: white;
            padding: 22px 18px;
            text-align: center;
            border-bottom: 4px solid #c9a959;
        }
        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .header i {
            color: #f9d27e;
        }
        .step-progress {
            background: #f8f4e5;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            color: #0b3b2c;
            border-bottom: 1px solid #d4c29c;
            flex-wrap: wrap;
        }
        .step-progress span {
            background: #1a5a44;
            color: white;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.2rem;
        }
        .content {
            padding: 25px 20px;
            background: #fefcf5;
            min-height: 420px;
        }
        .question-box {
            background: white;
            border-radius: 35px;
            padding: 30px 25px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.02);
            border: 1px solid #eee5d5;
            border-right: 8px solid #1a5a44;
        }
        .question-title {
            font-size: 1.7rem;
            font-weight: 700;
            color: #0b3b2c;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        .option-btn {
            flex: 1 1 130px;
            padding: 18px 20px;
            border: 2px solid #d4c29c;
            background: white;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .option-btn:hover {
            border-color: #1a5a44;
            background: #f0f7f3;
        }
        .option-btn.selected {
            background: #1a5a44;
            color: white;
            border-color: #1a5a44;
        }
        .input-field {
            width: 100%;
            padding: 18px 22px;
            border: 2px solid #e9e1d2;
            border-radius: 60px;
            font-size: 1.2rem;
            margin: 20px 0;
            background: white;
        }
        .input-field:focus {
            outline: none;
            border-color: #1a5a44;
            box-shadow: 0 0 0 4px rgba(26,90,68,0.1);
        }
        .counter-row {
            display: flex;
            align-items: center;
            gap: 20px;
            background: #f9f5ec;
            padding: 15px 25px;
            border-radius: 60px;
            margin: 15px 0;
        }
        .counter-label {
            font-size: 1.2rem;
            font-weight: 600;
            min-width: 100px;
        }
        .counter-control {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: center;
        }
        .counter-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1a5a44;
            color: white;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .counter-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .counter-value {
            font-size: 2rem;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 35px;
        }
        .btn {
            padding: 18px 25px;
            border: none;
            border-radius: 60px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex: 1;
            transition: 0.2s;
        }
        .btn-primary {
            background: #1a5a44;
            color: white;
            box-shadow: 0 8px 20px rgba(26,90,68,0.4);
        }
        .btn-secondary {
            background: #6c5b4b;
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result-card {
            background: linear-gradient(145deg, #1a5a44, #0e3b2e);
            color: white;
            border-radius: 35px;
            padding: 30px 25px;
            border: 1px solid #c9a959;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
        }
        .result-table th, .result-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .result-table th {
            background: rgba(0,0,0,0.3);
        }
        .total-amount {
            background: #c9a959;
            color: #0b3b2c;
            padding: 18px;
            border-radius: 60px;
            text-align: center;
            font-size: 1.6rem;
            font-weight: bold;
        }
        .footer {
            background: #f8f4e5;
            padding: 16px;
            text-align: center;
            color: #5a4e3a;
            border-top: 1px solid #d4c29c;
        }
        .hidden { display: none !important; }
        .summary-box {
            background: #e9f2f0;
            padding: 18px;
            border-radius: 25px;
            color: #0b3b2c;
            margin: 20px 0;
        }
        .badge {
            background: #c9a959;
            color: #0b3b2c;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            display: inline-block;
            margin: 5px;
        }
        .error-box {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 20px;
            margin: 20px 0;
            border-right: 5px solid #f5c6cb;
        }
        .tooltip {
            background: #e6f7f0;
            padding: 10px;
            border-radius: 20px;
            color: #0b3b2c;
            font-size: 0.95rem;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <div class="header">
            <h1><i class="fas fa-mosque"></i> Ø¹Ù„Ù…ÛŒ Ù…ÛŒØ±Ø§Ø« <i class="fas fa-star"></i></h1>
            <p>Ø¢Ø³Ø§Ù† Ø¹Ù„Ù… Ù…ÛŒØ±Ø§Ø« + Ø§Ù„Ø³Ø±Ø§Ø¬ÛŒ + Ø³ÙˆØ±Û Ù†Ø³Ø§Ø¡</p>
        </div>

        <div class="step-progress" id="stepIndicator">
            <span>1</span> Ù…ÛŒØª Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        </div>

        <div class="content" id="content">
            <!-- Dynamic content -->
        </div>

        <div class="footer">
            ØªÙ…Ø§Ù… Ø´Ø±Ø¹ÛŒ Ù‚ÙˆØ§Ø¹Ø¯ Ú©ÛŒ Ø±ÙˆØ´Ù†ÛŒ Ù…ÛŒÚº | ÙÙ‚Û Ø­Ù†ÙÛŒ | Ù…Ø³ØªÙ†Ø¯ Ú©ØªØ¨ Ø³Û’ Ù…Ø§Ø®ÙˆØ°
        </div>
    </div>

    <script>
        // ==================== Ù…Ú©Ù…Ù„ ÚˆÛŒÙ¹Ø§ Ù…Ø§ÚˆÙ„ ====================
        const state = {
            deceasedName: '',
            deceasedGender: null,
            userRelation: '',
            spouseExists: null,
            wifeCount: 0,
            sons: 0,
            daughters: 0,
            fatherAlive: false,
            motherAlive: false,
            paternalGrandfatherAlive: false,
            paternalGrandmotherAlive: false,
            maternalGrandmotherAlive: false,
            fullBrothers: 0,
            fullSisters: 0,
            consanguineBrothers: 0,
            consanguineSisters: 0,
            uterineBrothers: 0,
            uterineSisters: 0,
            grandsons: 0,
            granddaughters: 0,
            nephews: 0,
            assets: { cash: 0, property: 0, gold: 0, vehicle: 0, other: 0 },
            debts: 0,
            funeral: 0,
            will: 0,
            result: null
        };

        let currentStep = 1;

        // ==================== ÛÛŒÙ„Ù¾Ø± ====================
        function updateStepIndicator(text) {
            const el = document.getElementById('stepIndicator');
            if (el) el.innerHTML = `<span>${currentStep}</span> ${text}`;
        }

        // ==================== Ø±ÛŒÙ†ÚˆØ± Ø³Ù¹ÛŒÙ¾ ====================
        function renderStep() {
            const content = document.getElementById('content');
            if (!content) return;

            try {
                if (currentStep === 1) content.innerHTML = step1_DeceasedInfo();
                else if (currentStep === 2) content.innerHTML = step2_UserRelation();
                else if (currentStep === 3) content.innerHTML = step3_SpouseExists();
                else if (currentStep === 4) content.innerHTML = step4_WivesCount();
                else if (currentStep === 5) content.innerHTML = step5_Children();
                else if (currentStep === 6) content.innerHTML = step6_Parents();
                else if (currentStep === 7) content.innerHTML = step7_Grandparents();
                else if (currentStep === 8) content.innerHTML = step8_Siblings();
                else if (currentStep === 9) content.innerHTML = step9_Grandchildren();
                else if (currentStep === 10) content.innerHTML = step10_Nephews();
                else if (currentStep === 11) content.innerHTML = step11_Assets();
                else if (currentStep === 12) content.innerHTML = step12_DebtsWill();
                else if (currentStep === 13) { calculateResult(); content.innerHTML = step13_Result(); }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                content.innerHTML = `<div class="error-box"><i class="fas fa-exclamation-triangle"></i> Ø§ÛŒÚ© Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ú¯Ø¦ÛŒÛ” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”</div>`;
                console.error(e);
            }
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 1 ====================
        function step1_DeceasedInfo() {
            updateStepIndicator('Ù…ÛŒØª Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-user"></i> Ù…ÛŒØª Ú©Ø§ Ù†Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</div>
                    <input type="text" class="input-field" id="deceasedName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯" value="${state.deceasedName || ''}">
                    
                    <div class="question-title"><i class="fas fa-venus-mars"></i> Ù…ÛŒØª Ú©ÛŒ Ø¬Ù†Ø³</div>
                    <div class="options">
                        <button class="option-btn ${state.deceasedGender === 'male' ? 'selected' : ''}" onclick="setGender('male')"><i class="fas fa-mars"></i> Ù…Ø±Ø¯</button>
                        <button class="option-btn ${state.deceasedGender === 'female' ? 'selected' : ''}" onclick="setGender('female')"><i class="fas fa-venus"></i> Ø¹ÙˆØ±Øª</button>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="saveStep1()" ${!state.deceasedGender ? 'disabled' : ''}>Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 2 ====================
        function step2_UserRelation() {
            updateStepIndicator('Ø¢Ù¾ Ú©Ø§ Ø±Ø´ØªÛ');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-handshake"></i> Ø¢Ù¾ Ú©Ø§ Ù…ÛŒØª Ø³Û’ Ú©ÛŒØ§ Ø±Ø´ØªÛ ÛÛ’ØŸ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</div>
                    <input type="text" class="input-field" id="userRelation" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¨ÛŒÙ¹Ø§ØŒ Ø¨Ú¾Ø§Ø¦ÛŒ" value="${state.userRelation || ''}">
                    
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="saveStep2()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 3 ====================
        function step3_SpouseExists() {
            updateStepIndicator('Ø´Ø±ÛŒÚ© Ø­ÛŒØ§Øª');
            const question = state.deceasedGender === 'male' ? 'Ú©ÛŒØ§ Ù…ÛŒØª Ú©ÛŒ Ø¨ÛŒÙˆÛŒ/Ø¨ÛŒÙˆÛŒØ§Úº Ø²Ù†Ø¯Û ÛÛŒÚºØŸ' : 'Ú©ÛŒØ§ Ù…ÛŒØª Ú©Ø§ Ø´ÙˆÛØ± Ø²Ù†Ø¯Û ÛÛ’ØŸ';
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-heart"></i> ${question}</div>
                    <div class="options">
                        <button class="option-btn ${state.spouseExists === true ? 'selected' : ''}" onclick="setSpouse(true)">ÛØ§Úº</button>
                        <button class="option-btn ${state.spouseExists === false ? 'selected' : ''}" onclick="setSpouse(false)">Ù†ÛÛŒÚº</button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()" ${state.spouseExists === null ? 'disabled' : ''}>Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 4 ====================
        function step4_WivesCount() {
            if (state.deceasedGender === 'female' || !state.spouseExists) {
                currentStep = 5;
                return renderStep();
            }
            updateStepIndicator('Ø¨ÛŒÙˆÛŒÙˆÚº Ú©ÛŒ ØªØ¹Ø¯Ø§Ø¯');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-female"></i> Ú©ØªÙ†ÛŒ Ø¨ÛŒÙˆÛŒØ§Úº Ø²Ù†Ø¯Û ÛÛŒÚºØŸ</div>
                    <div class="counter-row">
                        <span class="counter-label">ØªØ¹Ø¯Ø§Ø¯:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeWives(-1)">âˆ’</button>
                            <span class="counter-value">${state.wifeCount}</span>
                            <button class="counter-btn" onclick="changeWives(1)">+</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 5 ====================
        function step5_Children() {
            updateStepIndicator('Ø§ÙˆÙ„Ø§Ø¯');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-child"></i> Ø§ÙˆÙ„Ø§Ø¯ Ú©ÛŒ ØªØ¹Ø¯Ø§Ø¯</div>
                    <div class="counter-row">
                        <span class="counter-label">Ø¨ÛŒÙ¹Û’:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeSons(-1)">âˆ’</button>
                            <span class="counter-value">${state.sons}</span>
                            <button class="counter-btn" onclick="changeSons(1)">+</button>
                        </div>
                    </div>
                    <div class="counter-row">
                        <span class="counter-label">Ø¨ÛŒÙ¹ÛŒØ§Úº:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeDaughters(-1)">âˆ’</button>
                            <span class="counter-value">${state.daughters}</span>
                            <button class="counter-btn" onclick="changeDaughters(1)">+</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 6 ====================
        function step6_Parents() {
            updateStepIndicator('ÙˆØ§Ù„Ø¯ÛŒÙ†');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-family"></i> ÙˆØ§Ù„Ø¯ÛŒÙ† Ú©ÛŒ Ù…ÙˆØ¬ÙˆØ¯Ú¯ÛŒ</div>
                    <div style="margin:15px 0;">
                        <button class="option-btn" style="width:100%; justify-content:flex-start;" onclick="toggleFather()">
                            <i class="fas ${state.fatherAlive ? 'fa-check-square' : 'fa-square'}"></i> Ø¨Ø§Ù¾ Ø²Ù†Ø¯Û ÛÛ’
                        </button>
                    </div>
                    <div style="margin:15px 0;">
                        <button class="option-btn" style="width:100%; justify-content:flex-start;" onclick="toggleMother()">
                            <i class="fas ${state.motherAlive ? 'fa-check-square' : 'fa-square'}"></i> Ù…Ø§Úº Ø²Ù†Ø¯Û ÛÛ’
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 7 ====================
        function step7_Grandparents() {
            if (state.fatherAlive) {
                currentStep = 8;
                return renderStep();
            }
            updateStepIndicator('Ø¯Ø§Ø¯Ø§ Ø¯Ø§Ø¯ÛŒ');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-family"></i> Ø¯Ø§Ø¯Ø§ Ø¯Ø§Ø¯ÛŒ Ú©Ø§ ÙˆØ¬ÙˆØ¯</div>
                    <div style="margin:15px 0;">
                        <button class="option-btn" style="width:100%; justify-content:flex-start;" onclick="togglePGF()">
                            <i class="fas ${state.paternalGrandfatherAlive ? 'fa-check-square' : 'fa-square'}"></i> Ø¯Ø§Ø¯Ø§ (Ø¨Ø§Ù¾ Ú©Ø§ Ø¨Ø§Ù¾) Ø²Ù†Ø¯Û ÛÛ’
                        </button>
                    </div>
                    <div style="margin:15px 0;">
                        <button class="option-btn" style="width:100%; justify-content:flex-start;" onclick="togglePGM()">
                            <i class="fas ${state.paternalGrandmotherAlive ? 'fa-check-square' : 'fa-square'}"></i> Ø¯Ø§Ø¯ÛŒ (Ø¨Ø§Ù¾ Ú©ÛŒ Ù…Ø§Úº) Ø²Ù†Ø¯Û ÛÛ’
                        </button>
                    </div>
                    <div style="margin:15px 0;">
                        <button class="option-btn" style="width:100%; justify-content:flex-start;" onclick="toggleMGM()">
                            <i class="fas ${state.maternalGrandmotherAlive ? 'fa-check-square' : 'fa-square'}"></i> Ù†Ø§Ù†ÛŒ (Ù…Ø§Úº Ú©ÛŒ Ù…Ø§Úº) Ø²Ù†Ø¯Û ÛÛ’
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 8 ====================
        function step8_Siblings() {
            updateStepIndicator('Ø¨ÛÙ† Ø¨Ú¾Ø§Ø¦ÛŒ');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-users"></i> Ø¨ÛÙ† Ø¨Ú¾Ø§Ø¦ÛŒÙˆÚº Ú©ÛŒ ØªØ¹Ø¯Ø§Ø¯</div>
                    
                    <div class="counter-row">
                        <span class="counter-label">Ø³Ú¯Û’ Ø¨Ú¾Ø§Ø¦ÛŒ:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeFullBrother(-1)">âˆ’</button>
                            <span class="counter-value">${state.fullBrothers}</span>
                            <button class="counter-btn" onclick="changeFullBrother(1)">+</button>
                        </div>
                    </div>
                    <div class="counter-row">
                        <span class="counter-label">Ø³Ú¯ÛŒ Ø¨ÛÙ†ÛŒÚº:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeFullSister(-1)">âˆ’</button>
                            <span class="counter-value">${state.fullSisters}</span>
                            <button class="counter-btn" onclick="changeFullSister(1)">+</button>
                        </div>
                    </div>
                    <div class="counter-row">
                        <span class="counter-label">Ø¹Ù„Ø§ØªÛŒ Ø¨Ú¾Ø§Ø¦ÛŒ (Ø¨Ø§Ù¾ Ø´Ø±ÛŒÚ©):</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeConsBrother(-1)">âˆ’</button>
                            <span class="counter-value">${state.consanguineBrothers}</span>
                            <button class="counter-btn" onclick="changeConsBrother(1)">+</button>
                        </div>
                    </div>
                    <div class="counter-row">
                        <span class="counter-label">Ø¹Ù„Ø§ØªÛŒ Ø¨ÛÙ†ÛŒÚº:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeConsSister(-1)">âˆ’</button>
                            <span class="counter-value">${state.consanguineSisters}</span>
                            <button class="counter-btn" onclick="changeConsSister(1)">+</button>
                        </div>
                    </div>
                    <div class="counter-row">
                        <span class="counter-label">Ø§Ø®ÛŒØ§ÙÛŒ Ø¨Ú¾Ø§Ø¦ÛŒ (Ù…Ø§Úº Ø´Ø±ÛŒÚ©):</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeUterBrother(-1)">âˆ’</button>
                            <span class="counter-value">${state.uterineBrothers}</span>
                            <button class="counter-btn" onclick="changeUterBrother(1)">+</button>
                        </div>
                    </div>
                    <div class="counter-row">
                        <span class="counter-label">Ø§Ø®ÛŒØ§ÙÛŒ Ø¨ÛÙ†ÛŒÚº:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeUterSister(-1)">âˆ’</button>
                            <span class="counter-value">${state.uterineSisters}</span>
                            <button class="counter-btn" onclick="changeUterSister(1)">+</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 9 ====================
        function step9_Grandchildren() {
            if (state.sons > 0) {
                currentStep = 10;
                return renderStep();
            }
            updateStepIndicator('Ù¾ÙˆØªÛ’ Ù¾ÙˆØªÛŒØ§Úº');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-child"></i> Ù¾ÙˆØªÛ’ Ù¾ÙˆØªÛŒØ§Úº (Ø¨ÛŒÙ¹Û’ Ú©ÛŒ Ø§ÙˆÙ„Ø§Ø¯)</div>
                    <div class="counter-row">
                        <span class="counter-label">Ù¾ÙˆØªÛ’:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeGrandson(-1)">âˆ’</button>
                            <span class="counter-value">${state.grandsons}</span>
                            <button class="counter-btn" onclick="changeGrandson(1)">+</button>
                        </div>
                    </div>
                    <div class="counter-row">
                        <span class="counter-label">Ù¾ÙˆØªÛŒØ§Úº:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeGranddaughter(-1)">âˆ’</button>
                            <span class="counter-value">${state.granddaughters}</span>
                            <button class="counter-btn" onclick="changeGranddaughter(1)">+</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 10 ====================
        function step10_Nephews() {
            if (state.fullBrothers > 0 || state.consanguineBrothers > 0) {
                currentStep = 11;
                return renderStep();
            }
            updateStepIndicator('Ø¨Ú¾ØªÛŒØ¬Û’');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-user-tie"></i> Ø¨Ú¾ØªÛŒØ¬Û’ (Ø³Ú¯Û’ Ø¨Ú¾Ø§Ø¦ÛŒ Ú©Ø§ Ø¨ÛŒÙ¹Ø§)</div>
                    <div class="counter-row">
                        <span class="counter-label">ØªØ¹Ø¯Ø§Ø¯:</span>
                        <div class="counter-control">
                            <button class="counter-btn" onclick="changeNephew(-1)">âˆ’</button>
                            <span class="counter-value">${state.nephews}</span>
                            <button class="counter-btn" onclick="changeNephew(1)">+</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="nextStep()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 11 ====================
        function step11_Assets() {
            updateStepIndicator('Ù…Ø§Ù„ Ùˆ Ø¬Ø§Ø¦ÛŒØ¯Ø§Ø¯');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-coins"></i> Ú©Ù„ ØªØ±Ú©Û (Ø±ÙˆÙ¾Û’ Ù…ÛŒÚº)</div>
                    <input type="number" class="input-field" id="cash" placeholder="Ù†Ù‚Ø¯ Ø±Ù‚Ù…" value="${state.assets.cash}" min="0" step="1000">
                    <input type="number" class="input-field" id="property" placeholder="Ø¬Ø§Ø¦ÛŒØ¯Ø§Ø¯ Ú©ÛŒ Ù‚ÛŒÙ…Øª" value="${state.assets.property}" min="0" step="1000">
                    <input type="number" class="input-field" id="gold" placeholder="Ø³ÙˆÙ†Ø§ / Ú†Ø§Ù†Ø¯ÛŒ" value="${state.assets.gold}" min="0" step="1000">
                    <input type="number" class="input-field" id="vehicle" placeholder="Ú¯Ø§Ú‘ÛŒ / Ù…Ø´ÛŒÙ†Ø±ÛŒ" value="${state.assets.vehicle}" min="0" step="1000">
                    <input type="number" class="input-field" id="other" placeholder="Ø¯ÛŒÚ¯Ø± Ø§Ø´ÛŒØ§Ø¡" value="${state.assets.other}" min="0" step="1000">
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="saveAssets()">Ø§Ú¯Ù„Ø§ <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 12 ====================
        function step12_DebtsWill() {
            updateStepIndicator('Ù‚Ø±Ø¶ Ùˆ ÙˆØµÛŒØª');
            return `
                <div class="question-box">
                    <div class="question-title"><i class="fas fa-file-invoice"></i> Ù‚Ø±Ø¶ Ø§ÙˆØ± Ø§Ø®Ø±Ø§Ø¬Ø§Øª</div>
                    <input type="number" class="input-field" id="debts" placeholder="Ù…ÛŒØª Ù¾Ø± Ù‚Ø±Ø¶ (Ø§Ú¯Ø± Ú©ÙˆØ¦ÛŒ ÛÙˆ)" value="${state.debts}" min="0" step="1000">
                    <input type="number" class="input-field" id="funeral" placeholder="ØªØ¬ÛÛŒØ² Ùˆ ØªÚ©ÙÛŒÙ† Ú©Û’ Ø§Ø®Ø±Ø§Ø¬Ø§Øª" value="${state.funeral}" min="0" step="1000">
                    <input type="number" class="input-field" id="will" placeholder="ÙˆØµÛŒØª Ú©ÛŒ Ø±Ù‚Ù… (Ø§ÛŒÚ© ØªÛØ§Ø¦ÛŒ Ø³Û’ Ø²ÛŒØ§Ø¯Û Ù†Û ÛÙˆ)" value="${state.will}" min="0" step="1000">
                    <div class="tooltip">
                        <i class="fas fa-info-circle"></i> ÙˆØµÛŒØª Ú©Ù„ ØªØ±Ú©Û Ú©Û’ â…“ Ø³Û’ Ø²ÛŒØ§Ø¯Û Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ØªÛŒÛ”
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> Ù¾Ú†Ú¾Ù„Ø§</button>
                        <button class="btn btn-primary" onclick="saveDebtsAndWill()">Ù†ØªÛŒØ¬Û Ø¯ÛŒÚ©Ú¾ÛŒÚº <i class="fas fa-calculator"></i></button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø³Ù¹ÛŒÙ¾ 13 ====================
        function step13_Result() {
            const r = state.result;
            if (!r || typeof r !== 'object') {
                return `<div class="error-box">Ú©ÙˆØ¦ÛŒ Ù†ØªÛŒØ¬Û Ù†ÛÛŒÚº Ù…Ù„ Ø³Ú©Ø§Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”</div>`;
            }

            let heirsList = '';
            let totalDistributed = 0;

            if (r.shares && Object.keys(r.shares).length > 0) {
                for (let [heir, amount] of Object.entries(r.shares)) {
                    if (amount && amount > 0) {
                        let heirName = heir;
                        const heirNames = {
                            husband: 'Ø´ÙˆÛØ±', wife: 'Ø¨ÛŒÙˆÛŒ', son: 'Ø¨ÛŒÙ¹Ø§', daughter: 'Ø¨ÛŒÙ¹ÛŒ',
                            father: 'Ø¨Ø§Ù¾', mother: 'Ù…Ø§Úº', paternalGrandfather: 'Ø¯Ø§Ø¯Ø§',
                            paternalGrandmother: 'Ø¯Ø§Ø¯ÛŒ', maternalGrandmother: 'Ù†Ø§Ù†ÛŒ',
                            fullBrother: 'Ø³Ú¯Ø§ Ø¨Ú¾Ø§Ø¦ÛŒ', fullSister: 'Ø³Ú¯ÛŒ Ø¨ÛÙ†',
                            consBrother: 'Ø¹Ù„Ø§ØªÛŒ Ø¨Ú¾Ø§Ø¦ÛŒ', consSister: 'Ø¹Ù„Ø§ØªÛŒ Ø¨ÛÙ†',
                            uterineBrother: 'Ø§Ø®ÛŒØ§ÙÛŒ Ø¨Ú¾Ø§Ø¦ÛŒ', uterineSister: 'Ø§Ø®ÛŒØ§ÙÛŒ Ø¨ÛÙ†',
                            grandson: 'Ù¾ÙˆØªØ§', granddaughter: 'Ù¾ÙˆØªÛŒ', nephew: 'Ø¨Ú¾ØªÛŒØ¬Ø§'
                        };
                        if (heirNames[heir]) heirName = heirNames[heir];
                        if (heir === 'wife' && state.wifeCount > 1) heirName = 'Ø¨ÛŒÙˆÛŒØ§Úº (' + state.wifeCount + ')';
                        const percent = r.netEstate > 0 ? ((amount / r.netEstate) * 100).toFixed(2) : '0';
                        heirsList += `<tr><td>${heirName}</td><td>${percent}%</td><td>${Math.round(amount)} Ø±ÙˆÙ¾Û’</td></tr>`;
                        totalDistributed += amount;
                    }
                }
            }

            if (!heirsList) {
                heirsList = '<tr><td colspan="3">Ú©ÙˆØ¦ÛŒ ÙˆØ§Ø±Ø« Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº (Ù…Ø§Ù„ Ø¨ÛŒØª Ø§Ù„Ù…Ø§Ù„ Ù…ÛŒÚº Ú†Ù„Ø§ Ø¬Ø§Ø¦Û’ Ú¯Ø§)</td></tr>';
            }

            return `
                <div class="result-card">
                    <h2 style="text-align:center; margin-bottom:20px;">ØªÙ‚Ø³ÛŒÙ… ÙˆØ±Ø§Ø«Øª</h2>
                    ${state.deceasedName ? `<p style="text-align:center;">Ù…ÛŒØª: ${state.deceasedName}</p>` : ''}
                    ${state.userRelation ? `<p style="text-align:center;">Ø¢Ù¾ Ú©Ø§ Ø±Ø´ØªÛ: ${state.userRelation}</p>` : ''}
                    <table class="result-table">
                        <tr><th>ÙˆØ§Ø±Ø«</th><th>ÙÛŒØµØ¯</th><th>Ø±Ù‚Ù…</th></tr>
                        ${heirsList}
                    </table>
                    <div class="total-amount">
                        Ú©Ù„ ØªÙ‚Ø³ÛŒÙ…: ${Math.round(totalDistributed)} Ø±ÙˆÙ¾Û’
                    </div>
                    <div class="summary-box">
                        <p><strong>Ø®Ù„Ø§ØµÛ:</strong></p>
                        <p>Ú©Ù„ ØªØ±Ú©Û: ${Math.round(r.totalEstate)} Ø±ÙˆÙ¾Û’</p>
                        <p>Ø§Ø®Ø±Ø§Ø¬Ø§Øª ØªØ¬ÛÛŒØ²: ${Math.round(r.funeral)} Ø±ÙˆÙ¾Û’</p>
                        <p>Ù‚Ø±Ø¶: ${Math.round(r.debts)} Ø±ÙˆÙ¾Û’</p>
                        <p>ÙˆØµÛŒØª: ${Math.round(r.will)} Ø±ÙˆÙ¾Û’</p>
                        <p>Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒÙ…: ${Math.round(r.netEstate)} Ø±ÙˆÙ¾Û’</p>
                    </div>
                    ${r.awl ? '<div class="badge">âš ï¸ Ø¹ÙˆÙ„ Ú©Ø§ Ø§Ø·Ù„Ø§Ù‚ (Ø­ØµÙˆÚº Ù…ÛŒÚº Ú©Ù…ÛŒ)</div>' : ''}
                    ${r.radd ? '<div class="badge">ğŸ”„ Ø±Ø¯ Ú©Ø§ Ø§Ø·Ù„Ø§Ù‚ (Ø¨Ù‚ÛŒÛ Ù…Ø§Ù„ ÙˆØ§Ù¾Ø³ Ø°ÙˆÛŒ Ø§Ù„ÙØ±ÙˆØ¶ Ù…ÛŒÚº)</div>' : ''}
                    <div style="display:flex; gap:15px; margin-top:20px;">
                        <button class="btn btn-secondary" onclick="restart()"><i class="fas fa-redo"></i> Ù†Ø¦ÛŒ ØªÙ‚Ø³ÛŒÙ…</button>
                        <button class="btn btn-primary" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ</button>
                    </div>
                </div>
            `;
        }

        // ==================== Ø§ÛŒÚ©Ø´Ù†Ø² ====================
        window.setGender = (g) => { state.deceasedGender = g; renderStep(); };
        window.setSpouse = (v) => { state.spouseExists = v; if (!v) state.wifeCount = 0; renderStep(); };
        window.changeWives = (d) => { state.wifeCount = Math.max(1, state.wifeCount + d); renderStep(); };
        window.changeSons = (d) => { state.sons = Math.max(0, state.sons + d); renderStep(); };
        window.changeDaughters = (d) => { state.daughters = Math.max(0, state.daughters + d); renderStep(); };
        window.toggleFather = () => { state.fatherAlive = !state.fatherAlive; renderStep(); };
        window.toggleMother = () => { state.motherAlive = !state.motherAlive; renderStep(); };
        window.togglePGF = () => { state.paternalGrandfatherAlive = !state.paternalGrandfatherAlive; renderStep(); };
        window.togglePGM = () => { state.paternalGrandmotherAlive = !state.paternalGrandmotherAlive; renderStep(); };
        window.toggleMGM = () => { state.maternalGrandmotherAlive = !state.maternalGrandmotherAlive; renderStep(); };
        window.changeFullBrother = (d) => { state.fullBrothers = Math.max(0, state.fullBrothers + d); renderStep(); };
        window.changeFullSister = (d) => { state.fullSisters = Math.max(0, state.fullSisters + d); renderStep(); };
        window.changeConsBrother = (d) => { state.consanguineBrothers = Math.max(0, state.consanguineBrothers + d); renderStep(); };
        window.changeConsSister = (d) => { state.consanguineSisters = Math.max(0, state.consanguineSisters + d); renderStep(); };
        window.changeUterBrother = (d) => { state.uterineBrothers = Math.max(0, state.uterineBrothers + d); renderStep(); };
        window.changeUterSister = (d) => { state.uterineSisters = Math.max(0, state.uterineSisters + d); renderStep(); };
        window.changeGrandson = (d) => { state.grandsons = Math.max(0, state.grandsons + d); renderStep(); };
        window.changeGranddaughter = (d) => { state.granddaughters = Math.max(0, state.granddaughters + d); renderStep(); };
        window.changeNephew = (d) => { state.nephews = Math.max(0, state.nephews + d); renderStep(); };

        window.saveStep1 = () => {
            state.deceasedName = document.getElementById('deceasedName')?.value || '';
            currentStep = 2;
            renderStep();
        };
        window.saveStep2 = () => {
            state.userRelation = document.getElementById('userRelation')?.value || '';
            currentStep = 3;
            renderStep();
        };
        window.nextStep = () => { currentStep++; renderStep(); };
        window.prevStep = () => { currentStep--; renderStep(); };

        window.saveAssets = () => {
            state.assets.cash = parseFloat(document.getElementById('cash')?.value) || 0;
            state.assets.property = parseFloat(document.getElementById('property')?.value) || 0;
            state.assets.gold = parseFloat(document.getElementById('gold')?.value) || 0;
            state.assets.vehicle = parseFloat(document.getElementById('vehicle')?.value) || 0;
            state.assets.other = parseFloat(document.getElementById('other')?.value) || 0;
            currentStep = 12;
            renderStep();
        };

        window.saveDebtsAndWill = () => {
            state.debts = parseFloat(document.getElementById('debts')?.value) || 0;
            state.funeral = parseFloat(document.getElementById('funeral')?.value) || 0;
            state.will = parseFloat(document.getElementById('will')?.value) || 0;
            currentStep = 13;
            renderStep();
        };

        // ==================== Ù…Ú©Ù…Ù„ Ø´Ø±Ø¹ÛŒ Ø­Ø³Ø§Ø¨ (ÙÙ‚Û Ø­Ù†ÙÛŒ) ====================
        function calculateResult() {
            try {
                let totalEstate = Object.values(state.assets).reduce((a, b) => a + b, 0);
                let afterExpenses = totalEstate - state.funeral - state.debts;
                if (afterExpenses < 0) afterExpenses = 0;

                let maxWill = afterExpenses * 1 / 3;
                let actualWill = Math.min(state.will, maxWill);
                let netEstate = afterExpenses - actualWill;
                if (netEstate < 0) netEstate = 0;

                // 1) ÙˆØ§Ø±Ø«ÙˆÚº Ú©ÛŒ Ù…ÙˆØ¬ÙˆØ¯Ú¯ÛŒ Ú©Û’ Ù…Ø·Ø§Ø¨Ù‚ Ø§Ù† Ú©ÛŒ Ø´Ù†Ø§Ø®Øª (Ø­Ø¬Ø¨ Ú©Ø§ Ø®ÛŒØ§Ù„ Ø±Ú©Ú¾ØªÛ’ ÛÙˆØ¦Û’)
                let heirs = {};

                // Ø´Ø±ÛŒÚ© Ø­ÛŒØ§Øª
                if (state.spouseExists) {
                    if (state.deceasedGender === 'male') heirs.wife = state.wifeCount || 1;
                    else heirs.husband = 1;
                }

                // Ø§ÙˆÙ„Ø§Ø¯
                let hasSon = state.sons > 0;
                let hasDaughter = state.daughters > 0;
                let hasChild = hasSon || hasDaughter;

                // Ø¨ÛŒÙ¹Û’
                if (hasSon) heirs.son = state.sons;
                // Ø¨ÛŒÙ¹ÛŒØ§Úº (Ø§Ú¯Ø± Ø¨ÛŒÙ¹Ø§ ÛÙˆ ØªÙˆ Ø¨ÛŒÙ¹ÛŒØ§Úº Ø¹ØµØ¨Û ÛÙˆ Ø¬Ø§Ø¦ÛŒÚº Ú¯ÛŒ)
                if (hasDaughter) heirs.daughter = state.daughters;

                // ÙˆØ§Ù„Ø¯ÛŒÙ†
                if (state.fatherAlive) heirs.father = 1;
                if (state.motherAlive) heirs.mother = 1;

                // Ø¯Ø§Ø¯Ø§ Ø¯Ø§Ø¯ÛŒ (ØµØ±Ù Ø§Ø³ ÙˆÙ‚Øª Ø¬Ø¨ Ø¨Ø§Ù¾ Ù…ÙˆØ¬ÙˆØ¯ Ù†Û ÛÙˆ)
                if (!state.fatherAlive) {
                    if (state.paternalGrandfatherAlive) heirs.paternalGrandfather = 1;
                    if (state.paternalGrandmotherAlive) heirs.paternalGrandmother = 1;
                }
                if (!state.motherAlive && state.maternalGrandmotherAlive) heirs.maternalGrandmother = 1;

                // Ø³Ú¯Û’ Ø¨ÛÙ† Ø¨Ú¾Ø§Ø¦ÛŒ (Ø¨ÛŒÙ¹Û’ ÛŒØ§ Ù¾ÙˆØªÛ’ ÛŒØ§ Ø¨Ø§Ù¾ Ú©ÛŒ Ù…ÙˆØ¬ÙˆØ¯Ú¯ÛŒ Ù…ÛŒÚº Ù…Ø­Ø±ÙˆÙ… ÛÙˆ Ø¬Ø§ØªÛ’ ÛÛŒÚº)
                let siblingsExcluded = hasSon || state.sons > 0 || state.grandsons > 0 || state.fatherAlive;
                if (!siblingsExcluded) {
                    if (state.fullBrothers > 0) heirs.fullBrother = state.fullBrothers;
                    if (state.fullSisters > 0) heirs.fullSister = state.fullSisters;
                }

                // Ø¹Ù„Ø§ØªÛŒ Ø¨ÛÙ† Ø¨Ú¾Ø§Ø¦ÛŒ (Ø³Ú¯Û’ Ø¨ÛÙ† Ø¨Ú¾Ø§Ø¦ÛŒÙˆÚº Ú©ÛŒ Ù…ÙˆØ¬ÙˆØ¯Ú¯ÛŒ Ù…ÛŒÚº Ù…Ø­Ø±ÙˆÙ…)
                let consExcluded = siblingsExcluded || state.fullBrothers > 0 || state.fullSisters > 0;
                if (!consExcluded) {
                    if (state.consanguineBrothers > 0) heirs.consBrother = state.consanguineBrothers;
                    if (state.consanguineSisters > 0) heirs.consSister = state.consanguineSisters;
                }

                // Ø§Ø®ÛŒØ§ÙÛŒ Ø¨ÛÙ† Ø¨Ú¾Ø§Ø¦ÛŒ (Ø¨Ú†ÙˆÚº ÛŒØ§ Ø¨Ø§Ù¾ Ú©ÛŒ Ù…ÙˆØ¬ÙˆØ¯Ú¯ÛŒ Ù…ÛŒÚº Ù…Ø­Ø±ÙˆÙ…)
                let uterineExcluded = hasChild || state.fatherAlive || state.grandsons > 0;
                if (!uterineExcluded) {
                    if (state.uterineBrothers > 0) heirs.uterineBrother = state.uterineBrothers;
                    if (state.uterineSisters > 0) heirs.uterineSister = state.uterineSisters;
                }

                // Ù¾ÙˆØªÛ’ Ù¾ÙˆØªÛŒØ§Úº (Ø¬Ø¨ Ø¨ÛŒÙ¹Ø§ Ù†Û ÛÙˆ)
                if (!hasSon) {
                    if (state.grandsons > 0) heirs.grandson = state.grandsons;
                    if (state.granddaughters > 0) heirs.granddaughter = state.granddaughters;
                }

                // Ø¨Ú¾ØªÛŒØ¬Û’ (Ø¬Ø¨ Ù†Û Ø¨ÛŒÙ¹Ø§ ÛÙˆØŒ Ù†Û Ù¾ÙˆØªØ§ØŒ Ù†Û Ø¨Ø§Ù¾ØŒ Ù†Û Ø¨Ú¾Ø§Ø¦ÛŒ)
                let nephewExcluded = hasSon || state.grandsons > 0 || state.fatherAlive || state.fullBrothers > 0 || state.consanguineBrothers > 0;
                if (!nephewExcluded && state.nephews > 0) {
                    heirs.nephew = state.nephews;
                }

                if (Object.keys(heirs).length === 0) {
                    state.result = { totalEstate, funeral: state.funeral, debts: state.debts, will: actualWill, netEstate, shares: {}, awl: false, radd: false };
                    return;
                }

                // 2) ÙØ±Ø¶ Ø­ØµØµ Ú©Ø§ Ø­Ø³Ø§Ø¨
                let shares = {};

                // --- Ø´ÙˆÛØ± ---
                if (heirs.husband) {
                    shares.husband = hasChild ? netEstate * 1 / 4 : netEstate * 1 / 2;
                }

                // --- Ø¨ÛŒÙˆÛŒ ---
                if (heirs.wife) {
                    shares.wife = hasChild ? netEstate * 1 / 8 : netEstate * 1 / 4;
                }

                // --- Ø¨Ø§Ù¾ ---
                if (heirs.father) {
                    if (hasChild) shares.father = netEstate * 1 / 6;
                    // Ø§Ú¯Ø± Ø¨ÛŒÙ¹Ø§ Ù†Û ÛÙˆ ØªÙˆ Ø¨Ø§Ù¾ Ø¹ØµØ¨Û Ø¨Ù†Û’ Ú¯Ø§ØŒ Ø¨Ø¹Ø¯ Ù…ÛŒÚº Ø¨Ù‚ÛŒÛ Ø¯Û’ Ø¯ÛŒÚº Ú¯Û’
                }

                // --- Ù…Ø§Úº ---
                if (heirs.mother) {
                    // Ù…Ø§Úº Ú©Ùˆ 1/6 Ø§Ú¯Ø± Ø§ÙˆÙ„Ø§Ø¯ ÛÙˆ ÛŒØ§ Ø¯Ùˆ Ø¨Ú¾Ø§Ø¦ÛŒ ÛÙˆÚº
                    let twoBrothers = (state.fullBrothers >= 2 || state.fullSisters >= 2 || state.consanguineBrothers >= 2 || state.consanguineSisters >= 2 || state.uterineBrothers >= 2 || state.uterineSisters >= 2);
                    if (hasChild || twoBrothers) {
                        shares.mother = netEstate * 1 / 6;
                    } else {
                        shares.mother = netEstate * 1 / 3;
                    }
                }

                // --- Ø¨ÛŒÙ¹ÛŒ (Ø¬Ø¨ Ø¨ÛŒÙ¹Ø§ Ù†Û ÛÙˆ) ---
                if (heirs.daughter && !heirs.son) {
                    if (state.daughters === 1) shares.daughter = netEstate * 1 / 2;
                    else shares.daughter = netEstate * 2 / 3; // Ø¯Ùˆ ÛŒØ§ Ø²ÛŒØ§Ø¯Û
                }

                // --- Ù¾ÙˆØªÛŒ (Ø¬Ø¨ Ø¨ÛŒÙ¹Ø§ Ù†Û ÛÙˆ Ø§ÙˆØ± Ø¨ÛŒÙ¹ÛŒ Ø¨Ú¾ÛŒ Ù†Û ÛÙˆ) ---
                if (heirs.granddaughter && !heirs.son && !heirs.daughter) {
                    if (state.granddaughters === 1) shares.granddaughter = netEstate * 1 / 2;
                    else shares.granddaughter = netEstate * 2 / 3;
                }

                // --- Ø³Ú¯ÛŒ Ø¨ÛÙ† (Ø¬Ø¨ Ø¨ÛŒÙ¹Ø§/Ø¨ÛŒÙ¹ÛŒ/Ø¨Ø§Ù¾/Ù¾ÙˆØªØ§ Ù†Û ÛÙˆ) ---
                if (heirs.fullSister && !hasSon && !hasDaughter && !state.fatherAlive && !state.grandsons) {
                    if (state.fullSisters === 1) shares.fullSister = netEstate * 1 / 2;
                    else shares.fullSister = netEstate * 2 / 3;
                }

                // --- Ø¹Ù„Ø§ØªÛŒ Ø¨ÛÙ† (Ø¬Ø¨ Ø³Ú¯ÛŒ Ø¨ÛÙ† Ù†Û ÛÙˆ) ---
                if (heirs.consSister && !hasSon && !hasDaughter && !state.fatherAlive && !state.grandsons && !state.fullSisters) {
                    if (state.consanguineSisters === 1) shares.consSister = netEstate * 1 / 2;
                    else shares.consSister = netEstate * 2 / 3;
                }

                // --- Ø§Ø®ÛŒØ§ÙÛŒ Ø¨ÛÙ† Ø¨Ú¾Ø§Ø¦ÛŒ ---
                if (heirs.uterineBrother || heirs.uterineSister) {
                    let count = (heirs.uterineBrother || 0) + (heirs.uterineSister || 0);
                    if (count === 1) shares.uterine = netEstate * 1 / 6;
                    else shares.uterine = netEstate * 1 / 3;
                }

                // --- Ø¯Ø§Ø¯Ø§ ---
                if (heirs.paternalGrandfather && !heirs.father) {
                    if (hasChild) shares.paternalGrandfather = netEstate * 1 / 6;
                    // ÙˆØ±Ù†Û Ø¹ØµØ¨Û
                }

                // --- Ø¯Ø§Ø¯ÛŒ ---
                if (heirs.paternalGrandmother && !heirs.mother) {
                    shares.paternalGrandmother = netEstate * 1 / 6;
                }

                // --- Ù†Ø§Ù†ÛŒ ---
                if (heirs.maternalGrandmother && !heirs.mother) {
                    shares.maternalGrandmother = netEstate * 1 / 6;
                }

                // 3) Ú©Ù„ ÙØ±Ø¶ Ø­ØµØµ Ú©Ø§ Ù…Ø¬Ù…ÙˆØ¹Û
                let totalFard = Object.values(shares).reduce((a, b) => a + b, 0);

                // Ø¹ÙˆÙ„ Ú©ÛŒ ØµÙˆØ±Øª
                let awl = false;
                if (totalFard > netEstate + 0.01) {
                    awl = true;
                    let ratio = netEstate / totalFard;
                    for (let k in shares) {
                        shares[k] *= ratio;
                    }
                    totalFard = netEstate;
                }

                // 4) Ø¨Ù‚ÛŒÛ Ù…Ø§Ù„ Ø¹ØµØ¨Û Ù…ÛŒÚº ØªÙ‚Ø³ÛŒÙ…
                let remaining = netEstate - totalFard;
                if (remaining > 0.01) {
                    // Ø¹ØµØ¨Û Ú©ÛŒ ØªØ±ØªÛŒØ¨:
                    // Ø¨ÛŒÙ¹Ø§, Ù¾ÙˆØªØ§, Ø¨Ø§Ù¾, Ø³Ú¯Ø§ Ø¨Ú¾Ø§Ø¦ÛŒ, Ø¹Ù„Ø§ØªÛŒ Ø¨Ú¾Ø§Ø¦ÛŒ, Ø¨Ú¾ØªÛŒØ¬Ø§, Ù¾Ú¾ÙˆÙ¾Ú¾ÛŒ ÙˆØºÛŒØ±Û
                    if (heirs.son) {
                        let sonUnits = heirs.son * 2;
                        let daughterUnits = heirs.daughter || 0;
                        let totalUnits = sonUnits + daughterUnits;
                        if (totalUnits > 0) {
                            let perUnit = remaining / totalUnits;
                            shares.son = (shares.son || 0) + perUnit * sonUnits;
                            if (heirs.daughter) shares.daughter = (shares.daughter || 0) + perUnit * daughterUnits;
                            remaining = 0;
                        }
                    } else if (heirs.grandson) {
                        let gsonUnits = heirs.grandson * 2;
                        let gdaughterUnits = heirs.granddaughter || 0;
                        let totalUnits = gsonUnits + gdaughterUnits;
                        if (totalUnits > 0) {
                            let perUnit = remaining / totalUnits;
                            shares.grandson = (shares.grandson || 0) + perUnit * gsonUnits;
                            if (heirs.granddaughter) shares.granddaughter = (shares.granddaughter || 0) + perUnit * gdaughterUnits;
                            remaining = 0;
                        }
                    } else if (heirs.father) {
                        shares.father = (shares.father || 0) + remaining;
                        remaining = 0;
                    } else if (heirs.fullBrother) {
                        let fbUnits = heirs.fullBrother * 2;
                        let fsUnits = heirs.fullSister || 0;
                        let totalUnits = fbUnits + fsUnits;
                        if (totalUnits > 0) {
                            let perUnit = remaining / totalUnits;
                            shares.fullBrother = (shares.fullBrother || 0) + perUnit * fbUnits;
                            if (heirs.fullSister) shares.fullSister = (shares.fullSister || 0) + perUnit * fsUnits;
                            remaining = 0;
                        }
                    } else if (heirs.consBrother) {
                        let cbUnits = heirs.consBrother * 2;
                        let csUnits = heirs.consSister || 0;
                        let totalUnits = cbUnits + csUnits;
                        if (totalUnits > 0) {
                            let perUnit = remaining / totalUnits;
                            shares.consBrother = (shares.consBrother || 0) + perUnit * cbUnits;
                            if (heirs.consSister) shares.consSister = (shares.consSister || 0) + perUnit * csUnits;
                            remaining = 0;
                        }
                    } else if (heirs.nephew) {
                        shares.nephew = (shares.nephew || 0) + remaining;
                        remaining = 0;
                    } else if (heirs.paternalGrandfather) {
                        shares.paternalGrandfather = (shares.paternalGrandfather || 0) + remaining;
                        remaining = 0;
                    }
                }

                // 5) Ø±Ø¯ (Ø¬Ø¨ Ú©ÙˆØ¦ÛŒ Ø¹ØµØ¨Û Ù†Û ÛÙˆ Ø§ÙˆØ± Ø¨ÛŒÙˆÛŒ/Ø´ÙˆÛØ± Ú©Û’ Ø¹Ù„Ø§ÙˆÛ Ø°ÙˆÛŒ Ø§Ù„ÙØ±ÙˆØ¶ ÛÙˆÚº)
                let radd = false;
                if (remaining > 0.01) {
                    // Ø§Ù† ÙˆØ§Ø±Ø«ÙˆÚº Ú©Ùˆ Ú†Ú¾ÙˆÚ‘ Ú©Ø± Ø¬Ù† Ú©Ø§ Ø­ØµÛ ÙØ±Ø¶ ÛÛ’ Ø§ÙˆØ± Ø´ÙˆÛØ±/Ø¨ÛŒÙˆÛŒ Ø¨Ú¾ÛŒ Ø´Ø§Ù…Ù„ Ù†ÛÛŒÚº ÛÙˆØªÛ’ Ø±Ø¯ Ù…ÛŒÚº
                    let raddHeirs = {};
                    for (let k in shares) {
                        if (k !== 'husband' && k !== 'wife' && shares[k] > 0) {
                            raddHeirs[k] = shares[k];
                        }
                    }
                    let totalRadd = Object.values(raddHeirs).reduce((a, b) => a + b, 0);
                    if (totalRadd > 0) {
                        radd = true;
                        for (let k in raddHeirs) {
                            shares[k] += remaining * (raddHeirs[k] / totalRadd);
                        }
                    }
                }

                // Ú†Ú¾ÙˆÙ¹Û’ Ø­ØµÙˆÚº Ú©Ùˆ Ø¯Ø±Ø³Øª Ú©Ø±Ù†Ø§
                for (let k in shares) {
                    if (shares[k] < 0.01) delete shares[k];
                }

                state.result = {
                    totalEstate,
                    funeral: state.funeral,
                    debts: state.debts,
                    will: actualWill,
                    netEstate,
                    shares,
                    awl,
                    radd
                };
            } catch (e) {
                console.error('Ø­Ø³Ø§Ø¨ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ:', e);
                state.result = {
                    totalEstate: 0, funeral: 0, debts: 0, will: 0, netEstate: 0,
                    shares: {}, awl: false, radd: false
                };
            }
        }

        // ==================== Ø¯ÙˆØ¨Ø§Ø±Û Ø´Ø±ÙˆØ¹ ====================
        window.restart = () => {
            Object.assign(state, {
                deceasedName: '',
                deceasedGender: null,
                userRelation: '',
                spouseExists: null,
                wifeCount: 0,
                sons: 0,
                daughters: 0,
                fatherAlive: false,
                motherAlive: false,
                paternalGrandfatherAlive: false,
                paternalGrandmotherAlive: false,
                maternalGrandmotherAlive: false,
                fullBrothers: 0,
                fullSisters: 0,
                consanguineBrothers: 0,
                consanguineSisters: 0,
                uterineBrothers: 0,
                uterineSisters: 0,
                grandsons: 0,
                granddaughters: 0,
                nephews: 0,
                assets: { cash: 0, property: 0, gold: 0, vehicle: 0, other: 0 },
                debts: 0,
                funeral: 0,
                will: 0,
                result: null
            });
            currentStep = 1;
            renderStep();
        };

        window.downloadPDF = () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('helvetica');
                doc.text('Ø¹Ù„Ù…ÛŒ Ù…ÛŒØ±Ø§Ø« Ø±Ù¾ÙˆØ±Ù¹ (Ø¢Ø³Ø§Ù† Ø¹Ù„Ù… Ù…ÛŒØ±Ø§Ø« + Ø§Ù„Ø³Ø±Ø§Ø¬ÛŒ)', 105, 20, { align: 'center' });
                let y = 30;
                doc.setFontSize(10);
                doc.text(`ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('ur-PK')}`, 105, y, { align: 'center' });
                y += 10;
                doc.line(20, y, 190, y);
                y += 5;

                const r = state.result;
                if (r && r.shares) {
                    for (let [heir, amount] of Object.entries(r.shares)) {
                        if (amount > 0) {
                            doc.text(`${heir}: ${Math.round(amount)} Ø±ÙˆÙ¾Û’`, 20, y);
                            y += 6;
                        }
                    }
                    y += 5;
                    doc.text(`Ú©Ù„ ØªØ±Ú©Û: ${Math.round(r.totalEstate)} Ø±ÙˆÙ¾Û’`, 20, y); y += 5;
                    doc.text(`Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒÙ…: ${Math.round(r.netEstate)} Ø±ÙˆÙ¾Û’`, 20, y);
                }
                doc.save('meras.pdf');
            } catch (e) {
                alert('PDF Ø¨Ù†Ø§Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ”');
            }
        };

        // Ø´Ø±ÙˆØ¹
        renderStep();
    </script>
</body>
</html>